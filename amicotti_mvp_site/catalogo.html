<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amicotti — Catálogo</title>
  <meta name="description" content="Catálogo de alimentos para mascotas. Entrega en Quito y Valles. Compra por WhatsApp." />
  <link rel="icon" href="assets/logo.png" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse para CSV robusto -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Evita saltos feos en imágenes */
    .img-box{height:12rem}
    .img-box img{max-height:11rem;object-fit:contain}
    /* Drawer */
    .drawer{transform:translateX(100%);transition:transform .25s ease}
    .drawer.open{transform:translateX(0)}
  </style>
</head>
<body class="bg-white text-gray-900">
  <!-- HEADER -->
  <header class="p-4 border-b bg-white/70 backdrop-blur sticky top-0 z-30">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <a href="index.html" class="flex items-center gap-2">
        <img src="assets/logo.png" class="w-9 h-9" alt="Amicotti"/>
        <span class="font-semibold">Amicotti</span>
      </a>
      <div class="flex items-center gap-2">
        <a id="waTop" target="_blank" class="hidden md:inline-flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded">WhatsApp</a>
        <button id="cartBtn" class="relative inline-flex items-center gap-2 px-3 py-2 border rounded">
          🛒 <span id="cartCount" class="text-sm">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- CONTROLES / FILTROS -->
  <section class="max-w-6xl mx-auto p-4 grid md:grid-cols-5 gap-4">
    <aside class="md:col-span-1 space-y-3">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Marca</label>
        <select id="fMarca" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Especie</label>
        <select id="fEspecie" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Categoría</label>
        <select id="fCategoria" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Buscar</label>
        <input id="fSearch" class="w-full border p-2 rounded" placeholder="Nombre, SKU…" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Ordenar</label>
        <select id="fSort" class="w-full border p-2 rounded">
          <option value="">—</option>
          <option value="precio-asc">Precio ↑</option>
          <option value="precio-desc">Precio ↓</option>
          <option value="nombre-asc">Nombre A–Z</option>
          <option value="nombre-desc">Nombre Z–A</option>
        </select>
      </div>
      <button id="clearFilters" class="w-full border p-2 rounded">Limpiar filtros</button>

      <!-- INFO -->
      <div class="text-xs text-gray-500 pt-2">
        <p>Tip: puedes escribir “urinary”, “persian”, “kitten”, etc. en el buscador.</p>
      </div>
    </aside>

    <main class="md:col-span-4">
      <!-- Mensajes -->
      <div id="alertBox" class="hidden mb-3 p-3 rounded bg-yellow-50 border text-sm text-yellow-900"></div>
      <!-- Grilla -->
      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
  </section>

  <!-- DRAWER CARRITO -->
  <div id="cartDrawer" class="drawer fixed top-0 right-0 w-96 max-w-full h-full bg-white border-l shadow-xl z-40">
    <div class="p-4 flex items-center justify-between border-b">
      <h2 class="text-lg font-semibold">Tu pedido</h2>
      <button id="closeCart" class="text-xl">✕</button>
    </div>
    <div id="cartList" class="p-4 space-y-3 overflow-y-auto" style="height:calc(100% - 10rem)"></div>
    <div class="p-4 border-t space-y-2">
      <div class="flex items-center justify-between">
        <span>Total:</span><strong id="cartTotal">$0.00</strong>
      </div>
      <button id="sendWA" class="w-full bg-green-600 text-white p-2 rounded">Enviar por WhatsApp</button>
      <button id="clearCart" class="w-full border p-2 rounded">Vaciar</button>
    </div>
  </div>

  <!-- BOTÓN WA FLOTANTE (móvil) -->
  <a id="waFloat" target="_blank" class="fixed bottom-4 right-4 md:hidden w-12 h-12 rounded-full bg-green-600 text-white grid place-items-center shadow-lg">WA</a>

  <footer class="border-t text-center text-xs text-gray-500 p-6">© Amicotti — Quito & Valles</footer>

  <script>
  // ================== CONFIG ==================
  const WA_PHONE = "593995315716"; // ← Reemplazar si hay número definitivo único
  // Opción A: Catálogo unificado
  // Usar múltiples CSV (Purina + Royal)
const CSV_URLS = ["/amicotti_mvp_site/data/purina.csv", "/amicotti_mvp_site/data/royal.csv"];
  // Opción B: Catálogo por marca (descomenta y comenta la línea de arriba)
  // const CSV_URLS = ["data/purina.csv", "data/royal.csv"]; 

  // ================== ESTADO ==================
  let PRODUCTS = [];        // productos disponibles (desde CSV)
  let CART = loadCart();    // carrito desde localStorage

  // ================== SELECTORES ==================
  const grid = document.getElementById('grid');
  const fMarca = document.getElementById('fMarca');
  const fEspecie = document.getElementById('fEspecie');
  const fCategoria = document.getElementById('fCategoria');
  const fSearch = document.getElementById('fSearch');
  const fSort = document.getElementById('fSort');
  const alertBox = document.getElementById('alertBox');
  const cartBtn = document.getElementById('cartBtn');
  const cartDrawer = document.getElementById('cartDrawer');
  const cartList = document.getElementById('cartList');
  const cartTotal = document.getElementById('cartTotal');
  const cartCount = document.getElementById('cartCount');

  // ================== UTILIDADES ==================
  function money(n){ const x=Number(n); return Number.isFinite(x)?('$'+x.toFixed(2)):'—'; }
  function weight(g){ if(!g) return '' ; g=Number(g); return g>=1000? (g/1000)+" kg" : g+" g"; }
  function unique(arr,key){ return [...new Set(arr.map(o => (o[key]||'').trim()).filter(Boolean))].sort(); }

  // ================== WHATSAPP LINKS ==================
  function setWALinks(){
    const url = `https://wa.me/${WA_PHONE}`;
    const top = document.getElementById('waTop');
    const flo = document.getElementById('waFloat');
    if(top) { top.href = url; top.textContent = `WhatsApp ${WA_PHONE}`; }
    if(flo) { flo.href = url; }
  }

  // ================== CARRITO ==================
  function loadCart(){ try{ return JSON.parse(localStorage.getItem('amicart'))||[] }catch{ return [] } }
  function saveCart(){ localStorage.setItem('amicart', JSON.stringify(CART)); updateCartBadge(); }
  function updateCartBadge(){ const c=CART.reduce((a,i)=>a+i.qty,0); cartCount.textContent=c; }
  function openCart(){ cartDrawer.classList.add('open'); }
  function closeCart(){ cartDrawer.classList.remove('open'); }

  function addToCart(p){
    const key = p.sku || p.id;
    const i = CART.findIndex(x=>x.key===key);
    if(i>=0) CART[i].qty += 1; else CART.push({key, sku:p.sku, nombre:p.nombre, peso_g:p.peso_g, precio:p.precio, qty:1});
    saveCart(); drawCart(); openCart();
  }
  function chgQty(key,d){
    const i = CART.findIndex(x=>x.key===key); if(i<0) return;
    CART[i].qty += d; if(CART[i].qty<=0) CART.splice(i,1);
    saveCart(); drawCart();
  }
  function removeFromCart(key){ CART = CART.filter(x=>x.key!==key); saveCart(); drawCart(); }
  function drawCart(){
    if(!CART.length){ cartList.innerHTML = `<p class='text-sm text-gray-500'>Tu carrito está vacío.</p>`; cartTotal.textContent='$0.00'; return; }
    cartList.innerHTML = CART.map(it=>{
      const subtotal = it.precio!=null ? it.precio*it.qty : null;
      return `<div class='flex items-start justify-between gap-2'>
        <div class='text-sm'>
          <div class='font-medium'>${it.nombre}</div>
          <div class='text-gray-500'>${it.sku||''} ${it.peso_g?('• '+weight(it.peso_g)):''}</div>
          <div>${it.precio!=null? money(it.precio):'Consultar'}</div>
          <div class='flex items-center gap-2 mt-1'>
            <button class='border px-2 rounded' onclick="chgQty('${it.key}',-1)">−</button>
            <span>${it.qty}</span>
            <button class='border px-2 rounded' onclick="chgQty('${it.key}',1)">+</button>
          </div>
        </div>
        <div class='text-right'>
          ${subtotal!=null?`<div class='font-semibold'>${money(subtotal)}</div>`:''}
          <button class='text-red-500 text-sm mt-2' onclick="removeFromCart('${it.key}')">Eliminar</button>
        </div>
      </div>`
    }).join('');
    const total = CART.reduce((a,i)=> a + (i.precio!=null? i.precio*i.qty:0), 0);
    cartTotal.textContent = money(total);
  }
  function buildWAMessage(){
    let lines = [];
    lines.push('🛍️ *Pedido Amicotti*');
    CART.forEach(it=>{
      const price = it.precio!=null?` — ${money(it.precio)} c/u`:'';
      lines.push(`• ${it.nombre}${it.peso_g?(' — '+weight(it.peso_g)):''} — Cant: ${it.qty}${price}`);
    });
    const total = CART.reduce((a,i)=> a + (i.precio!=null? i.precio*i.qty:0), 0);
    if(total>0) lines.push(`\nTotal estimado: *${money(total)}*`);
    lines.push('\nNombre y sector para la entrega:');
    return lines.join('\n');
  }
  function sendWA(){ if(!CART.length) return alert('Tu carrito está vacío.'); window.open(`https://wa.me/${WA_PHONE}?text=${encodeURIComponent(buildWAMessage())}`,'_blank'); }

  // ================== CSV / PRODUCTOS ==================
  async function loadCSVs(){
    const loads = CSV_URLS.map(url => new Promise((resolve,reject)=>{
      Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});
    }));
    const arrays = await Promise.all(loads);
    const merged = arrays.flat();
    // Normalización: acepta esquema "master" o "purina/royal"
PRODUCTS = arrays.flat().map((r, idx) => {
  const hasBrandSchema = ('brand' in r) || ('name' in r) || ('species' in r);
  if (hasBrandSchema) {
    // --- CSV estilo Purina/Royal: id,brand,name,species,category,variants,image_url
    const specie = (r.species || '').trim().toLowerCase();
    const categoriaRaw = (r.category || '').trim().toLowerCase();
    const especie = specie === 'cat' ? 'Gato' : specie === 'dog' ? 'Perro' : '';
    const categoria = categoriaRaw === 'dry' ? 'Seco'
                     : categoriaRaw === 'wet' ? 'Húmedo'
                     : categoriaRaw === 'veterinary' ? 'Veterinario'
                     : categoriaRaw === 'treats' ? 'Snack'
                     : '';
    // tomar la PRIMERA variante solo para mostrar "Presentación"
    let peso_g = null;
    if (r.variants) {
      const v = String(r.variants).split('|')[0].trim(); // ej "500g" | "1.5kg" | "unidad"
      if (/unidad/i.test(v)) { peso_g = null; }
      else if (/kg/i.test(v)) { const n = parseFloat(v); if (!isNaN(n)) peso_g = Math.round(n * 1000); }
      else if (/g/i.test(v))  { const n = parseFloat(v); if (!isNaN(n)) peso_g = Math.round(n); }
    }
    return {
      id: r.id || ('row'+idx),
      marca: (r.brand || '').toString().trim(),
      linea: '',
      especie,
      categoria,
      nombre: (r.name || '').toString().trim(),
      peso_g,
      sku: '',                 // opcional por ahora
      precio: null,            // mostramos "Consultar"
      imagen_url: (r.image_url || '').toString().trim(),
      descripcion: '',
      disponible: true
    };
  } else {
    // --- CSV estilo "master": ya viene con las columnas esperadas
    return {
      id: r.id || ('row'+idx),
      marca: (r.marca||'').trim(),
      linea: (r.linea||'').trim(),
      especie: (r.especie||'').trim(),
      categoria: (r.categoria||'').trim(),
      nombre: (r.nombre||'').trim(),
      peso_g: r.peso_g ? Number(r.peso_g) : null,
      sku: (r.sku||'').trim(),
      precio: r.precio!=='' && r.precio!=null ? Number(r.precio) : null,
      imagen_url: (r.imagen_url||'').trim(),
      descripcion: (r.descripcion||'').trim(),
      disponible: String(r.disponible||'1')==='1'
    };
  }
}).filter(p => p.disponible);

   
  // ================== FILTROS ==================
  function fillSelect(sel, values){ sel.innerHTML = values.map((v,i)=>`<option value="${i===0?'':v}">${v}</option>`).join(''); }
  function fillFilters(){
    fillSelect(fMarca, ['Marca…', ...unique(PRODUCTS,'marca')]);
    fillSelect(fEspecie, ['Especie…', 'Gato', 'Perro']);
    fillSelect(fCategoria, ['Categoría…', ...unique(PRODUCTS,'categoria')]);
  }

  // ================== RENDER ==================
  function getFiltered(){
    const m=fMarca.value, e=fEspecie.value, c=fCategoria.value, q=(fSearch.value||'').trim().toLowerCase();
    let out = PRODUCTS.filter(p=>
      (!m || p.marca===m) &&
      (!e || p.especie===e) &&
      (!c || p.categoria===c) &&
      (!q || p.nombre.toLowerCase().includes(q) || p.linea.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q))
    );
    switch(fSort.value){
      case 'precio-asc': out.sort((a,b)=>(a.precio??1e9)-(b.precio??1e9)); break;
      case 'precio-desc': out.sort((a,b)=>(b.precio??-1)-(a.precio??-1)); break;
      case 'nombre-asc': out.sort((a,b)=>a.nombre.localeCompare(b.nombre)); break;
      case 'nombre-desc': out.sort((a,b)=>b.nombre.localeCompare(a.nombre)); break;
    }
    return out;
  }

  function cardHTML(p){
    const peso = weight(p.peso_g);
    const precio = p.precio!=null? money(p.precio) : 'Consultar';
    const img = p.imagen_url || 'assets/placeholder.png';
    const badgeVet = (p.categoria.toLowerCase()==='veterinario') ? `<span class='px-2 py-0.5 text-[10px] bg-rose-100 text-rose-700 rounded'>Veterinario</span>` : '';
    return `<article class='border rounded-lg overflow-hidden bg-white'>
      <div class='img-box w-full bg-gray-50 grid place-items-center'>
        <img src='${img}' alt='${p.nombre}' loading='lazy'/>
      </div>
      <div class='p-3 space-y-1'>
        <h3 class='font-medium leading-tight'>${p.nombre}</h3>
        <p class='text-xs text-gray-500'>${p.marca} • ${p.linea || '—'} • ${p.especie} ${badgeVet}</p>
        <p class='text-xs text-gray-500'>Presentación: ${peso || '—'}</p>
        <div class='flex items-center justify-between pt-2'>
          <strong>${precio}</strong>
          <button class='px-2 py-1 border rounded text-sm' onclick='addToCart(${JSON.stringify({id:""}).replace("{}","" )})'>Agregar</button>
        </div>
      </div>
    </article>`
    .replace("{\"id\":\"\"}", JSON.stringify(p).replace(/'/g,"&apos;"));
  }

  function render(){
    const items = getFiltered();
    if(!items.length){
      grid.innerHTML = `<div class='col-span-full p-6 text-center text-sm text-gray-500 border rounded'>No hay productos con esos filtros.</div>`;
      return;
    }
    grid.innerHTML = items.map(cardHTML).join('');
  }

  // ================== EVENTOS ==================
  [fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el=> el.addEventListener('input', render));
  document.getElementById('clearFilters').addEventListener('click',()=>{
    [fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el=> el.value=''); render();
  });
  document.getElementById('sendWA').addEventListener('click', sendWA);
  document.getElementById('clearCart').addEventListener('click', ()=>{ if(confirm('¿Vaciar carrito?')){ CART=[]; saveCart(); drawCart(); }});
  cartBtn.addEventListener('click', openCart);
  document.getElementById('closeCart').addEventListener('click', closeCart);

  // ================== INIT ==================
  (async function init(){
    setWALinks();
    updateCartBadge();
    try{
      await loadCSVs();
      if(!PRODUCTS.length){
        alertBox.classList.remove('hidden');
        alertBox.textContent = 'No se cargaron productos. Revisa las rutas CSV en /data y que el sitio no esté en una subcarpeta con rutas absolutas.';
      }
      fillFilters();
      render();
      drawCart();
    }catch(e){
      console.error(e);
      alertBox.classList.remove('hidden');
      alertBox.textContent = 'Error cargando el catálogo. Verifica rutas y formato del CSV.';
    }
  })();
  </script>
</body>
</html>


