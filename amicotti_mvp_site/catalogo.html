<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amicotti ‚Äî Cat√°logo</title>
  <meta name="description" content="Cat√°logo de alimentos para mascotas. Entrega en Quito y Valles. Compra por WhatsApp." />
  <link rel="icon" href="assets/logo.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .img-box{height:12rem}
    .img-box img{max-height:11rem;object-fit:contain}
    .drawer{transform:translateX(100%);transition:transform .25s ease}
    .drawer.open{transform:translateX(0)}
  </style>
</head>
<body class="bg-white text-gray-900">
  <!-- HEADER -->
  <header class="p-4 border-b bg-white/70 backdrop-blur sticky top-0 z-30">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <a href="/index.html" class="flex items-center gap-2">
        <img src="/assets/logo.png" class="w-9 h-9" alt="Amicotti"/>
        <span class="font-semibold">Amicotti</span>
      </a>
      <div class="flex items-center gap-2">
        <a id="waTop" target="_blank" class="hidden md:inline-flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded">WhatsApp</a>
        <button id="cartBtn" class="relative inline-flex items-center gap-2 px-3 py-2 border rounded">
          üõí <span id="cartCount" class="text-sm">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- CONTROLES -->
  <section class="max-w-6xl mx-auto p-4 grid md:grid-cols-5 gap-4">
    <aside class="md:col-span-1 space-y-3">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Marca</label>
        <select id="fMarca" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Especie</label>
        <select id="fEspecie" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Categor√≠a</label>
        <select id="fCategoria" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Buscar</label>
        <input id="fSearch" class="w-full border p-2 rounded" placeholder="Nombre, SKU‚Ä¶" />
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Ordenar</label>
        <select id="fSort" class="w-full border p-2 rounded">
          <option value="">‚Äî</option>
          <option value="precio-asc">Precio ‚Üë</option>
          <option value="precio-desc">Precio ‚Üì</option>
          <option value="nombre-asc">Nombre A‚ÄìZ</option>
          <option value="nombre-desc">Nombre Z‚ÄìA</option>
        </select>
      </div>
      <button id="clearFilters" class="w-full border p-2 rounded">Limpiar filtros</button>
      <div class="text-xs text-gray-500 pt-2">
        <p>Tip: escribe ‚Äúurinary‚Äù, ‚Äúpersian‚Äù, ‚Äúkitten‚Äù, etc.</p>
      </div>
    </aside>

    <main class="md:col-span-4">
      <div id="alertBox" class="hidden mb-3 p-3 rounded bg-yellow-50 border text-sm text-yellow-900"></div>
      <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
  </section>

  <!-- DRAWER CARRITO -->
  <div id="cartDrawer" class="drawer fixed top-0 right-0 w-96 max-w-full h-full bg-white border-l shadow-xl z-40 flex flex-col">
    <div class="p-4 flex items-center justify-between border-b">
      <h2 class="text-lg font-semibold">Tu pedido</h2>
      <button id="closeCart" class="text-xl">‚úï</button>
    </div>

    <!-- Lista de √≠tems -->
    <div id="cartItems" class="p-4 space-y-3 overflow-y-auto" style="height:calc(100% - 22rem)"></div>

    <!-- Datos del cliente -->
    <div class="p-4 border-t space-y-3">
    <form id="buyerForm" class="space-y-3" autocomplete="on">
  <div>
    <label for="bf_name" class="block text-xs text-gray-600 mb-1">Nombre completo *</label>
    <input id="bf_name" type="text" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="Ej. Renan Morales">
  </div>

  <div>
    <label for="bf_address" class="block text-xs text-gray-600 mb-1">Direcci√≥n exacta *</label>
    <textarea id="bf_address" rows="2" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="Calle, n√∫mero, referencias‚Ä¶"></textarea>
    <p class="mt-1 text-[11px] text-gray-500">Al abrir el chat podr√°s adjuntar tu ubicaci√≥n (pin).</p>
  </div>

  <div>
    <label for="bf_phone" class="block text-xs text-gray-600 mb-1">Tel√©fono (WhatsApp) *</label>
    <input id="bf_phone" type="tel" inputmode="tel" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="099 999 9999">
    <p id="bf_phone_help" class="mt-1 text-[11px] text-rose-600 hidden">Ingresa un n√∫mero v√°lido de Ecuador.</p>
  </div>

<div>
  <label class="block text-xs text-gray-600 mb-2">Forma de pago *</label>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
    <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
      <input type="radio" name="bf_pay" value="Transferencia bancaria" checked>
      <span class="text-sm">Transferencia bancaria</span>
    </label>
    <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
      <input type="radio" name="bf_pay" value="Contraentrega (efectivo)">
      <span class="text-sm">Contraentrega (efectivo)</span>
    </label>
  </div>
</div>

      
  <label class="flex items-start gap-2 text-sm select-none">
    <input id="bf_consent" type="checkbox" required class="mt-1">
    <span>Acepto que Amicotti use mis datos para coordinar la entrega y enviar novedades. <a href="#" class="underline">Privacidad</a>.</span>
  </label>
</form>
 
    </div>

    <!-- Totales + CTA -->
    <div class="p-4 border-t space-y-2">
      <div class="flex items-center justify-between text-sm text-gray-600">
        <span>Subtotal</span><strong id="cartSubtotal">$0.00</strong>
      </div>
      <div class="flex items-center justify-between text-sm text-gray-600">
        <span>Env√≠o</span><span>Por confirmar (Quito/Valles)</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="font-semibold">Total estimado</span><strong id="cartTotal">$0.00</strong>
      </div>

      <button id="btnCheckout" class="w-full bg-rose-600 text-white py-3 rounded font-semibold hover:bg-rose-700">Finalizar pedido</button>
      <button id="btnEmpty" class="w-full border p-2 rounded">Vaciar</button>
    </div>
  </div>

  <!-- BOT√ìN WA FLOTANTE -->
  <a id="waFloat" target="_blank" class="fixed bottom-4 right-4 md:hidden w-12 h-12 rounded-full bg-green-600 text-white grid place-items-center shadow-lg">WA</a>

  <footer class="border-t text-center text-xs text-gray-500 p-6">¬© Amicotti ‚Äî Quito & Valles</footer>

  <script>
/* ================= CONFIG ================= */
const WA_PHONE = "593995315716";
const CSV_URLS = ["/data/purina.csv","/data/royal.csv"];
const IMG_EXTS = [".webp", ".jpg", ".jpeg", ".png", ".avif"];

/* Google Forms (tus IDs reales) */
const FORM_ID       = "1FAIpQLSfsSxhFoBs9Xkv5MmYjTwr98zTSR6IefJ-vm2p9FSUOMSs69g";
const ENTRY_NAME    = "entry.1205890323"; // Nombre
const ENTRY_ADDRESS = "entry.1074248946"; // Direcci√≥n
const ENTRY_PHONE   = "entry.646283436";  // Tel√©fono
const ENTRY_CART    = "entry.1875788310"; // JSON carrito
const ENTRY_TOTAL   = "entry.624785838";  // Total $
const ENTRY_SOURCE  = "entry.1894560572"; // (opcional) "site-amicotti"
const ENTRY_PAYMETHOD = "entry.1704422038"; // Forma de pago

    
/* ================= ESTADO ================= */
let PRODUCTS = [];
let CART = loadCart();
const SELECTED = Object.create(null); // id -> √≠ndice de variante

/* ================= HELPERS ================= */
/* ====== Tel√©fono Ecuador: formato y validaci√≥n ====== */
function normalizeEcPhone(raw){
  const digits = String(raw||'').replace(/\D+/g,'');
  if(digits.startsWith('593')) return '593' + digits.slice(3,12);
  if(digits.startsWith('09'))  return '0'   + digits.slice(1,10);
  if(digits.startsWith('9'))   return '0'   + digits.slice(0,9);
  return digits.slice(0,10);
}
function isValidEcPhone(raw){
  const n = normalizeEcPhone(raw);
  return /^0?9\d{8}$/.test(n) || /^5939\d{8}$/.test(n);
}
function prettyEcPhone(raw){
  const n = normalizeEcPhone(raw);
  if(/^0?9\d{8}$/.test(n)){
    const ten = n.startsWith('0') ? n : '0'+n;
    return `${ten.slice(0,3)} ${ten.slice(3,6)} ${ten.slice(6,10)}`;
  }
  if(/^5939\d{8}$/.test(n)){
    const ten = '0'+n.slice(3);
    return `${ten.slice(0,3)} ${ten.slice(3,6)} ${ten.slice(6,10)}`;
  }
  return raw;
}
    
function money(n){ const x=Number(n); return (Number.isFinite(x) && x>=0) ? ('$'+x.toFixed(2)) : 'Consultar'; }
function gramsFromLabel(lbl){
  if(!lbl) return null;
  if(/unidad/i.test(lbl)) return null;
  let m = lbl.match(/([\d.,]+)\s*kg/i); if(m){ const v=parseFloat(m[1].replace(',','.')); return isNaN(v)?null:Math.round(v*1000); }
  m = lbl.match(/([\d.,]+)\s*g/i); if(m){ const v=parseFloat(m[1].replace(',','.')); return isNaN(v)?null:Math.round(v); }
  return null;
}
function parseVariants(str){
  if(!str) return [];
  return String(str).split('|').map(s=>{
    const raw = s.trim();
    const parts = raw.split(/[:\-‚Äî]+/);
    const label = (parts[0]||'').trim();
    const grams = gramsFromLabel(label);
    let price = null;
    if(parts[1]){ const num = parseFloat(parts[1].replace('$','').trim()); if(!isNaN(num)) price = num; }
    return label ? { label, grams, price } : null;
  }).filter(Boolean);
}
function unique(arr,key){ return [...new Set(arr.map(o => (o[key]||'').trim()).filter(Boolean))].sort(); }

/* ================= WHATSAPP ================= */
function setWALinks(){
  const url = `https://wa.me/${WA_PHONE}`;
  const top = document.getElementById('waTop');
  const flo = document.getElementById('waFloat');
  if(top){ top.href=url; top.textContent=`WhatsApp ${WA_PHONE}`; }
  if(flo){ flo.href=url; }
}

/* ================= CARRITO ================= */
function loadCart(){ try{ return JSON.parse(localStorage.getItem('amicart'))||[] }catch{ return [] } }
function saveCart(){ localStorage.setItem('amicart', JSON.stringify(CART)); updateCartBadge(); }
function updateCartBadge(){ const c=CART.reduce((a,i)=>a+i.qty,0); document.getElementById('cartCount').textContent=c; }
function openCart(){ document.getElementById('cartDrawer').classList.add('open'); }
function closeCart(){ document.getElementById('cartDrawer').classList.remove('open'); }

function addToCartById(pid){
  const p = PRODUCTS.find(x=>x.id===pid); if(!p) return;
  const idx = Number.isInteger(SELECTED[pid]) ? SELECTED[pid] : 0;
  const v = (p.variants && p.variants[idx]) || null;
  const key = pid + '::' + (v?v.label:'');

  const item = {
    key, sku: pid,
    nombre: p.nombre,
    presentacion: v ? v.label : '',
    peso_g: v ? v.grams : (p.peso_g || null),
    precio: v ? v.price : (p.precio ?? null),
    qty: 1
  };

  const i = CART.findIndex(x=>x.key===key);
  if(i>=0) CART[i].qty += 1; else CART.push(item);
  saveCart(); drawCart(); openCart();
}
function chgQty(key,d){
  const i=CART.findIndex(x=>x.key===key); if(i<0) return;
  CART[i].qty += d; if(CART[i].qty<=0) CART.splice(i,1);
  saveCart(); drawCart();
}
function removeFromCart(key){ CART = CART.filter(x=>x.key!==key); saveCart(); drawCart(); }

function cartSubtotal(){ 
  return CART.reduce((a,i)=> a + (i.precio!=null ? i.precio*i.qty : 0), 0); 
}

function drawCart(){
  const list = document.getElementById('cartItems');
  const subEl = document.getElementById('cartSubtotal');
  const totEl = document.getElementById('cartTotal');

  if(!CART.length){
    list.innerHTML = `<p class='text-sm text-gray-500'>Tu carrito est√° vac√≠o.</p>`;
    subEl.textContent = '$0.00'; totEl.textContent = '$0.00';
    return;
  }

  list.innerHTML = CART.map(it=>{
    const subtotal = it.precio!=null ? it.precio*it.qty : null;
    return `<div class='flex items-start justify-between gap-2'>
      <div class='text-sm'>
        <div class='font-medium'>${it.nombre}</div>
        <div class='text-gray-500'>
          ${it.sku||''} ${it.presentacion?('‚Ä¢ '+it.presentacion):''}
        </div>
        <div>${money(it.precio)}</div>
        <div class='flex items-center gap-2 mt-1'>
          <button class='border px-2 rounded' onclick="chgQty('${it.key}',-1)">‚àí</button>
          <span>${it.qty}</span>
          <button class='border px-2 rounded' onclick="chgQty('${it.key}',1)">+</button>
        </div>
      </div>
      <div class='text-right'>
        ${subtotal!=null?`<div class='font-semibold'>${money(subtotal)}</div>`:''}
        <button class='text-red-500 text-sm mt-2' onclick="removeFromCart('${it.key}')">Eliminar</button>
      </div>
    </div>`;
  }).join('');

  const sub = cartSubtotal();
  subEl.textContent = money(sub);
  totEl.textContent = money(sub); // env√≠o por confirmar
}

/* ================= IM√ÅGENES (fallback robusto) ================= */
function swapExt(url, ext){
  const i = url.lastIndexOf('.'); if(i<0) return url + ext;
  return url.slice(0,i) + ext;
}
function buildImgCandidates(p){
  const brand = (p.marca||'').toLowerCase();
  if(p.imagen_url && p.imagen_url.trim()){
    const first = p.imagen_url.trim();
    const alts = IMG_EXTS.map(e => swapExt(first, e));
    const uniq = [first, ...alts].filter((v,i,a)=>a.indexOf(v)===i);
    return uniq;
  }
  const base = brand.includes('royal') ? '/assets/royal/' :
               brand.includes('purina') ? '/assets/purina/' : '/assets/catalog/';
  return IMG_EXTS.map(ext => `${base}${p.id}${ext}`);
}
function onImgError(el){
  const rest = (el.dataset.alt || "").split("|").filter(Boolean);
  if(rest.length){ el.src = rest.shift(); el.dataset.alt = rest.join("|"); }
  else { el.onerror = null; el.src = "/assets/logo.png"; }
}

/* ================= CSV / PRODUCTOS ================= */
async function loadCSVs(){
  const loads = CSV_URLS.map(url => new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});
  }));
  const arrays = await Promise.all(loads);

  PRODUCTS = arrays.flat().map((r, idx)=>{
    const hasBrandSchema = ('brand' in r) || ('name' in r) || ('species' in r);
    if(hasBrandSchema){
      const specie = (r.species||'').trim().toLowerCase();
      const categoriaRaw = (r.category||'').trim().toLowerCase();
      const especie = specie==='cat' ? 'Gato' : specie==='dog' ? 'Perro' : '';
      const categoria = categoriaRaw==='dry' ? 'Seco'
                      : categoriaRaw==='wet' ? 'H√∫medo'
                      : categoriaRaw==='veterinary' ? 'Veterinario'
                      : categoriaRaw==='treats' ? 'Snack' : '';
      const variants = parseVariants(r.variants||'');
      const first = variants[0] || null;
      return {
        id: r.id || ('row'+idx),
        marca: (r.brand||'').toString().trim(),
        linea: '',
        especie,
        categoria,
        nombre: (r.name||'').toString().trim(),
        peso_g: first ? first.grams : null,
        sku: '',
        precio: first ? first.price : null,
        imagen_url: (r.image_url||'').toString().trim(),
        descripcion: '',
        disponible: true,
        variants
      };
    }else{
      const variants = parseVariants(r.variants||'');
      const first = variants[0] || null;
      return {
        id: r.id || ('row'+idx),
        marca: (r.marca||'').trim(),
        linea: (r.linea||'').trim(),
        especie: (r.especie||'').trim(),
        categoria: (r.categoria||'').trim(),
        nombre: (r.nombre||'').trim(),
        peso_g: r.peso_g ? Number(r.peso_g) : (first?first.grams:null),
        sku: (r.sku||'').trim(),
        precio: (r.precio!=='' && r.precio!=null) ? Number(r.precio) : (first?first.price:null),
        imagen_url: (r.imagen_url||'').trim(),
        descripcion: (r.descripcion||'').trim(),
        disponible: String(r.disponible||'1')==='1',
        variants
      };
    }
  }).filter(p=>p.disponible);
}

/* ================= FILTROS + RENDER ================= */
const grid = document.getElementById('grid');
const fMarca = document.getElementById('fMarca');
const fEspecie = document.getElementById('fEspecie');
const fCategoria = document.getElementById('fCategoria');
const fSearch = document.getElementById('fSearch');
const fSort = document.getElementById('fSort');
const alertBox = document.getElementById('alertBox');

const urlParams = new URLSearchParams(location.search);
const norm = v => (v||'').toString().trim().toLowerCase();
function mapEspecie(v){
  v = norm(v);
  if(v==='cat' || v==='gato') return 'Gato';
  if(v==='dog' || v==='perro') return 'Perro';
  return '';
}
function mapCategoria(v){
  v = norm(v);
  if(v==='dry' || v==='seco') return 'Seco';
  if(v==='wet' || v==='h√∫medo' || v==='humedo') return 'H√∫medo';
  if(v==='veterinary' || v==='veterinario' || v==='vet') return 'Veterinario';
  if(v==='snack' || v==='treats') return 'Snack';
  return '';
}
function applyInitialFiltersFromURL(){
  const marcaParam = urlParams.get('marca');
  if(marcaParam){
    const opts = unique(PRODUCTS,'marca');
    const exact = opts.find(m => m === marcaParam);
    const byNorm = opts.find(m => norm(m) === norm(marcaParam));
    fMarca.value = exact || byNorm || '';
  }
  const espParam = urlParams.get('especie'); if(espParam){ fEspecie.value = mapEspecie(espParam); }
  const catParam = urlParams.get('categoria'); if(catParam){ fCategoria.value = mapCategoria(catParam); }
  const qParam = urlParams.get('q'); if(qParam){ fSearch.value = qParam; }
  const sortParam = urlParams.get('orden'); if(sortParam){ fSort.value = sortParam; }
}
function updateURLFromFilters(){
  const params = new URLSearchParams();
  if(fMarca.value) params.set('marca', fMarca.value);
  if(fEspecie.value) params.set('especie', fEspecie.value);
  if(fCategoria.value) params.set('categoria', fCategoria.value);
  if(fSearch.value.trim()) params.set('q', fSearch.value.trim());
  if(fSort.value) params.set('orden', fSort.value);
  const qs = params.toString();
  history.replaceState(null, '', window.location.pathname + (qs?('?'+qs):''));
}
function fillSelect(sel, values){ sel.innerHTML = values.map((v,i)=>`<option value="${i===0?'':v}">${v}</option>`).join(''); }
function fillFilters(){
  fillSelect(fMarca, ['Marca‚Ä¶', ...unique(PRODUCTS,'marca')]);
  fillSelect(fEspecie, ['Especie‚Ä¶', 'Gato', 'Perro']);
  fillSelect(fCategoria, ['Categor√≠a‚Ä¶', ...unique(PRODUCTS,'categoria')]);
}
function getFiltered(){
  const m=fMarca.value, e=fEspecie.value, c=fCategoria.value, q=(fSearch.value||'').trim().toLowerCase();
  let out = PRODUCTS.filter(p=>
    (!m || p.marca===m) &&
    (!e || p.especie===e) &&
    (!c || p.categoria===c) &&
    (!q || p.nombre.toLowerCase().includes(q) || p.linea.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q))
  );
  switch(fSort.value){
    case 'precio-asc': out.sort((a,b)=>((a.variants?.[0]?.price ?? a.precio ?? 1e9) - (b.variants?.[0]?.price ?? b.precio ?? 1e9))); break;
    case 'precio-desc': out.sort((a,b)=>((b.variants?.[0]?.price ?? b.precio ?? -1) - (a.variants?.[0]?.price ?? a.precio ?? -1))); break;
    case 'nombre-asc': out.sort((a,b)=>a.nombre.localeCompare(b.nombre)); break;
    case 'nombre-desc': out.sort((a,b)=>b.nombre.localeCompare(a.nombre)); break;
  }
  return out;
}
function onChangeVariant(pid, idx){
  SELECTED[pid] = Number(idx)||0;
  const p = PRODUCTS.find(x=>x.id===pid); if(!p) return;
  const v = p.variants[SELECTED[pid]] || null;
  const priceEl = document.getElementById('price-'+pid);
  if(priceEl) priceEl.textContent = v ? money(v.price) : money(p.precio);
}
function cardHTML(p){
  const candidates = buildImgCandidates(p);
  const img = candidates[0];
  const altList = candidates.slice(1).join("|");
  const badgeVet = (p.categoria.toLowerCase()==='veterinario') ? `<span class='px-2 py-0.5 text-[10px] bg-rose-100 text-rose-700 rounded'>Veterinario</span>` : '';
  const variantsSel = (p.variants && p.variants.length) ? `
    <label class="block text-xs text-gray-500 mt-2">Presentaci√≥n</label>
    <select class="w-full border p-2 rounded text-sm" onchange="onChangeVariant('${p.id}', this.value)">
      ${p.variants.map((v,i)=>`<option value="${i}">${v.label}${v.price!=null?(' ‚Äî '+money(v.price)):''}</option>`).join('')}
    </select>
  ` : `<p class='text-xs text-gray-500 mt-1'>Presentaci√≥n: ${p.peso_g? (p.peso_g>=1000? (p.peso_g/1000)+' kg' : p.peso_g+' g') : '‚Äî'}</p>`;
  const initialPrice = (p.variants && p.variants.length) ? money(p.variants[0].price) : money(p.precio);
  return `<article class='border rounded-lg overflow-hidden bg-white'>
    <div class='img-box w-full bg-gray-50 grid place-items-center'>
      <img src='${img}' data-alt='${altList}' alt='${p.nombre}' loading='lazy' onerror="onImgError(this)"/>
    </div>
    <div class='p-3 space-y-1'>
      <h3 class='font-medium leading-tight'>${p.nombre}</h3>
      <p class='text-xs text-gray-500'>${p.marca} ‚Ä¢ ${p.linea || '‚Äî'} ‚Ä¢ ${p.especie} ${badgeVet}</p>
      ${variantsSel}
      <div class='flex items-center justify-between pt-2'>
        <strong id="price-${p.id}">${initialPrice}</strong>
        <button class='px-2 py-1 border rounded text-sm' onclick="addToCartById('${p.id}')">Agregar</button>
      </div>
    </div>
  </article>`;
}
function render(){
  const items = getFiltered();
  if(!items.length){
    grid.innerHTML = `<div class='col-span-full p-6 text-center text-sm text-gray-500 border rounded'>No hay productos con esos filtros.</div>`;
    return;
  }
  items.forEach(p=>{ if(!(p.id in SELECTED)) SELECTED[p.id]=0; });
  grid.innerHTML = items.map(cardHTML).join('');
}

/* ================= DATOS CLIENTE + WHATSAPP + SHEETS ================= */
function getBuyer(){
  const rawPhone  = (document.getElementById('bf_phone')?.value || '').trim();
  const normPhone = normalizeEcPhone(rawPhone);
  const ten = normPhone.startsWith('593') ? '0'+normPhone.slice(3) : normPhone;

  return {
    name:    (document.getElementById('bf_name')?.value || '').trim(),
    address: (document.getElementById('bf_address')?.value || '').trim(),
    phone:   prettyEcPhone(ten),
    pay:     (document.querySelector('input[name="bf_pay"]:checked')?.value || '').trim()
  };
}


function persistBuyer(b){
  localStorage.setItem('amicotti_buyer', JSON.stringify(b));
}
function prefillBuyer(){
  try{
    const b = JSON.parse(localStorage.getItem('amicotti_buyer')||'{}');
    if(b.name) document.getElementById('bf_name').value = b.name;
    if(b.address) document.getElementById('bf_address').value = b.address;
    if(b.phone) document.getElementById('bf_phone').value = b.phone;
  }catch(e){}
}
function buildWAMessage(buyer){
  const lines = [];
  lines.push('Pedido Amicotti');
  lines.push(`Nombre: ${buyer.name}`);
  lines.push(`Direcci√≥n: ${buyer.address}`);
  lines.push(`Tel√©fono: ${buyer.phone}`);
  lines.push(`Forma de pago: ${buyer.pay || '‚Äî'}`);
  lines.push('');
  lines.push('Items:');
  CART.forEach(it=>{
    const qty = Number(it.qty||1);
    const p   = Number(it.precio||0);
    const total = (p*qty).toFixed(2);
    const pres = it.presentacion ? ` ‚Äî ${it.presentacion}` : '';
    lines.push(`‚Ä¢ ${it.nombre}${pres} ‚Äî $${p.toFixed(2)} √ó ${qty} = $${total}`);
  });
  const sub = cartSubtotal().toFixed(2);
  lines.push('');
  lines.push(`Subtotal: $${sub}`);
  lines.push('Env√≠o: por confirmar (Quito/Valles)');
  lines.push(`Total Estimado : $${sub}`);
  lines.push('');
  lines.push('Por favor comparte tu ubicaci√≥n (pin) en este chat para entregar m√°s r√°pido. ¬°Gracias! üêæ');
  return lines.join('\n');
}
function sendToGoogleForms(buyer){
  if(!FORM_ID) return Promise.resolve();
  // Endpoint correcto: /d/e/${FORM_ID}/formResponse
  const endpoint = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
  const payload = new URLSearchParams();
  const sub = cartSubtotal().toFixed(2);
  if(ENTRY_NAME)    payload.append(ENTRY_NAME, buyer.name);
  if(ENTRY_ADDRESS) payload.append(ENTRY_ADDRESS, buyer.address);
  if(ENTRY_PHONE)   payload.append(ENTRY_PHONE, buyer.phone);
  if(ENTRY_PAYMETHOD) payload.append(ENTRY_PAYMETHOD, buyer.pay);
  if(ENTRY_TOTAL)   payload.append(ENTRY_TOTAL, sub);
  if(ENTRY_CART)    payload.append(ENTRY_CART, JSON.stringify(CART));
  if(ENTRY_SOURCE)  payload.append(ENTRY_SOURCE, 'site-amicotti');
  // No bloquea el flujo si falla
  return fetch(endpoint, { method:'POST', mode:'no-cors', body: payload }).catch(()=>{});
}
async function finalizarPedido(){
  if(!CART.length){ alert('Tu carrito est√° vac√≠o.'); return; }

  const buyer   = getBuyer();
  const consent = document.getElementById('bf_consent')?.checked;

  if(!buyer.name || !buyer.address || !buyer.phone){
    alert('Por favor completa Nombre, Direcci√≥n y Tel√©fono.'); return;
  }
  if(!isValidEcPhone(buyer.phone)){
    alert('Revisa el tel√©fono. Debe ser un m√≥vil v√°lido de Ecuador (09xxxxxxxx o +5939xxxxxxxx).');
    return;
  }
  if(!consent){
    alert('Debes aceptar el uso de datos para continuar.'); return;
  }

  persistBuyer(buyer);
  sendToGoogleForms(buyer); // no bloquea

  const text = buildWAMessage(buyer);
  const url  = `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank', 'noopener');

  // Limpia carrito despu√©s de abrir WhatsApp
  CART = [];
  saveCart();
  drawCart();
}


/* ================= EVENTOS ================= */
[fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el =>
  el.addEventListener('input', ()=>{ render(); updateURLFromFilters(); })
);
document.getElementById('clearFilters').addEventListener('click',()=>{
  [fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el=> el.value='');
  render(); updateURLFromFilters();
});
document.getElementById('cartBtn').addEventListener('click', openCart);
document.getElementById('closeCart').addEventListener('click', closeCart);
document.getElementById('btnEmpty').addEventListener('click', ()=>{
  if(confirm('¬øVaciar carrito?')){ CART=[]; saveCart(); drawCart(); }
});
document.getElementById('btnCheckout').addEventListener('click', finalizarPedido);
// Formato en vivo del tel√©fono
const bfPhoneInput = document.getElementById('bf_phone');
const bfPhoneHelp  = document.getElementById('bf_phone_help');
if(bfPhoneInput){
  bfPhoneInput.addEventListener('input', () => {
    const pos = bfPhoneInput.selectionStart;
    const pretty = prettyEcPhone(bfPhoneInput.value);
    bfPhoneInput.value = pretty;
    if(isValidEcPhone(bfPhoneInput.value)){
      bfPhoneInput.classList.remove('border-rose-400');
      bfPhoneHelp?.classList.add('hidden');
    }else{
      bfPhoneInput.classList.add('border-rose-400');
      bfPhoneHelp?.classList.remove('hidden');
    }
    try{ bfPhoneInput.setSelectionRange(pos,pos); }catch(e){}
  });
}
    

/* ================= INIT ================= */
(async function init(){
  setWALinks(); updateCartBadge();
  try{
    await loadCSVs();
    if(!PRODUCTS.length){
      alertBox.classList.remove('hidden');
      alertBox.textContent = 'No se cargaron productos. Revisa las rutas CSV.';
    }
    fillFilters();
    applyInitialFiltersFromURL();
    render();
    drawCart();
    prefillBuyer();
  }catch(e){
    console.error(e);
    alertBox.classList.remove('hidden');
    alertBox.textContent = 'Error cargando el cat√°logo. Verifica rutas y formato del CSV.';
  }
})();
  </script>
</body>
</html>
