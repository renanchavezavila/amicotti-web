<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amicotti â€” CatÃ¡logo</title>
  <meta name="description" content="CatÃ¡logo de alimentos y accesorios para mascotas. Entrega en Quito y Valles. Compra por WhatsApp." />
  <link rel="icon" href="assets/logo.png" />

  <!-- Tailwind + PapaParse -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>

  <style>
    :root{ --pastel:#F6F3E9; --pastel-2:#EFEAE0; }
   .img-box{height:12rem}
.img-box img{
  max-height:11rem;
  object-fit:contain;
  opacity:0;
  transition:opacity .18s ease;
  cursor:zoom-in;
}
.img-box img.loaded{opacity:1}

/* Modal de zoom */
.zoom-modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:60}
.zoom-modal.show{display:flex}
.zoom-frame{position:relative;width:min(92vw,1100px);height:min(92vh,800px);background:#111;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px #0006}
.zoom-toolbar{position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:2}
.zoom-toolbar button{background:#fff;border:1px solid #ddd;border-radius:8px;padding:.4rem .6rem;font-size:.9rem}
.zoom-stage{width:100%;height:100%;touch-action:none}
.zoom-stage img{max-width:none;max-height:none;display:block;cursor:grab}
.zoom-stage img:active{cursor:grabbing}
.zoom-caption{position:absolute;left:12px;bottom:10px;color:#fff;font-size:.75rem;opacity:.85}

    .drawer{transform:translateX(100%);transition:transform .25s ease}
    .drawer.open{transform:translateX(0)}
    .overlay{position:fixed;inset:0;background:#0005;opacity:0;pointer-events:none;transition:.2s}
    .overlay.show{opacity:1;pointer-events:auto}
    .no-scroll{overflow:hidden}
    .hctrl{min-width:10rem}
    @media (max-width:1024px){ .hctrl{min-width:auto} }
  </style>
</head>

<body class="bg-white text-gray-900">
  <!-- HEADER -->
  <header class="sticky top-0 z-40 border-b bg-[color:var(--pastel)]/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="flex items-center gap-2 shrink-0">
        <img src="assets/logo.png" class="w-9 h-9" alt="Amicotti"/>
        <span class="font-semibold">Amicotti</span>
      </a>

      <!-- Controles (desktop) -->
      <div class="hidden lg:flex items-center gap-2 flex-1">
        <select id="fMarca" class="hctrl border rounded px-2 py-2 text-sm bg-white"></select>
        <select id="fEspecie" class="hctrl border rounded px-2 py-2 text-sm bg-white"></select>
        <select id="fCategoria" class="hctrl border rounded px-2 py-2 text-sm bg-white"></select>
        <input id="fSearch" class="hctrl border rounded px-3 py-2 text-sm bg-white flex-1" placeholder="Buscar: nombre, SKUâ€¦" />
        <select id="fSort" class="hctrl border rounded px-2 py-2 text-sm bg-white">
          <option value="">Ordenarâ€¦</option>
          <option value="precio-asc">Precio â†‘</option>
          <option value="precio-desc">Precio â†“</option>
          <option value="nombre-asc">Nombre Aâ€“Z</option>
          <option value="nombre-desc">Nombre Zâ€“A</option>
        </select>
        <button id="clearFilters" class="ml-1 px-3 py-2 text-sm border rounded bg-white">Limpiar</button>
      </div>

      <!-- BotÃ³n filtros (mÃ³vil) -->
      <button id="openFilters" class="lg:hidden ml-auto px-3 py-2 border rounded bg-white">Filtros</button>

      <!-- Acciones -->
      <div class="flex items-center gap-2">
        <a id="waTop" target="_blank" class="hidden md:inline-flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded">WhatsApp</a>
        <button id="cartBtn" class="relative inline-flex items-center gap-2 px-3 py-2 border rounded bg-white">
          ðŸ›’ <span id="cartCount" class="text-sm">0</span>
        </button>
      </div>
    </div>

    <!-- Panel filtros mÃ³vil -->
    <div id="filtersPanel" class="lg:hidden border-t bg-[color:var(--pastel-2)] py-3 hidden">
      <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
        <select id="m_fMarca" class="border rounded px-2 py-2 text-sm bg-white"></select>
        <select id="m_fEspecie" class="border rounded px-2 py-2 text-sm bg-white"></select>
        <select id="m_fCategoria" class="border rounded px-2 py-2 text-sm bg-white"></select>
        <select id="m_fSort" class="border rounded px-2 py-2 text-sm bg-white">
          <option value="">Ordenarâ€¦</option>
          <option value="precio-asc">Precio â†‘</option>
          <option value="precio-desc">Precio â†“</option>
          <option value="nombre-asc">Nombre Aâ€“Z</option>
          <option value="nombre-desc">Nombre Zâ€“A</option>
        </select>
        <input id="m_fSearch" class="border rounded px-3 py-2 text-sm bg-white sm:col-span-2" placeholder="Buscar: nombre, SKUâ€¦" />
        <button id="m_clearFilters" class="border rounded px-3 py-2 text-sm bg-white sm:col-span-2">Limpiar</button>
      </div>
    </div>
  </header>

  <!-- GRID -->
  <main class="max-w-7xl mx-auto p-4">
    <div id="alertBox" class="hidden mb-3 p-3 rounded bg-yellow-50 border text-sm text-yellow-900"></div>
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>

  <!-- OVERLAY -->
  <div id="overlay" class="overlay"></div>

  <!-- DRAWER CARRITO -->
  <div id="cartDrawer" class="drawer fixed top-0 right-0 w-[420px] max-w-full h-full bg-white border-l shadow-xl z-50 flex flex-col">
    <div class="p-4 flex items-center justify-between border-b">
      <h2 class="text-lg font-semibold">Tu pedido</h2>
      <div class="flex items-center gap-2">
        <a href="cart.html" class="text-sm underline">Ver carrito</a>
        <button id="closeCart" class="text-xl" aria-label="Cerrar">âœ•</button>
      </div>
    </div>

    <!-- Items -->
    <div id="cartItems" class="p-4 space-y-3 overflow-y-auto" style="height:calc(100% - 20rem)"></div>

    <!-- Datos del cliente (OCULTO EN CATALOGO) -->
    <div id="buyerBlock" class="p-4 border-t space-y-3 hidden">
      <form id="buyerForm" class="space-y-3" autocomplete="on">
        <div>
          <label for="bf_name" class="block text-xs text-gray-600 mb-1">Nombre completo *</label>
          <input id="bf_name" type="text" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="Ej. Mario Morales">
        </div>
        <div>
          <label for="bf_address" class="block text-xs text-gray-600 mb-1">DirecciÃ³n exacta *</label>
          <textarea id="bf_address" rows="2" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="Calle, nÃºmero, referenciasâ€¦"></textarea>
          <p class="mt-1 text-[11px] text-gray-500">En WhatsApp podrÃ¡s adjuntar tu ubicaciÃ³n (pin).</p>
        </div>
        <div>
          <label for="bf_phone" class="block text-xs text-gray-600 mb-1">TelÃ©fono (WhatsApp) *</label>
          <input id="bf_phone" type="tel" inputmode="tel" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-rose-200" placeholder="099 999 9999">
          <p id="bf_phone_help" class="mt-1 text-[11px] text-rose-600 hidden">Ingresa un nÃºmero vÃ¡lido de Ecuador.</p>
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-2">Forma de pago *</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
              <input type="radio" name="bf_pay" value="Transferencia Bancaria" checked>
              <span class="text-sm">Transferencia bancaria</span>
            </label>
            <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
              <input type="radio" name="bf_pay" value="Contraentrega (efectivo)">
              <span class="text-sm">Contraentrega (efectivo)</span>
            </label>
          </div>
        </div>
        <label class="flex items-start gap-2 text-sm select-none">
          <input id="bf_consent" type="checkbox" required class="mt-1">
          <span>Acepto que Amicotti use mis datos para coordinar la entrega y enviar novedades. <a href="#" class="underline">Privacidad</a>.</span>
        </label>
      </form>
    </div>

    <!-- Totales + CTA -->
    <div class="p-4 border-t space-y-2">
      <div class="flex items-center justify-between text-sm text-gray-600">
        <span>Subtotal</span><strong id="cartSubtotal">$0.00</strong>
      </div>
      <div class="flex items-center justify-between text-sm text-gray-600">
        <span>EnvÃ­o</span><span>Por confirmar (Quito/Valles)</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="font-semibold">Total estimado</span><strong id="cartTotal">$0.00</strong>
      </div>
      <button id="btnCheckout" class="w-full bg-rose-600 text-white py-3 rounded font-semibold hover:bg-rose-700">Finalizar pedido</button>
      <button onclick="location.href='cart.html'" class="w-full border p-2 rounded">Ver carrito (pantalla completa)</button>
      <button id="btnEmpty" class="w-full border p-2 rounded">Vaciar</button>
    </div>
  </div>

  <!-- BOTÃ“N WA FLOTANTE -->
  <a id="waFloat" target="_blank" class="fixed bottom-4 right-4 md:hidden w-12 h-12 rounded-full bg-green-600 text-white grid place-items-center shadow-lg">WA</a>

  <footer class="border-t text-center text-xs text-gray-500 p-6">Â© Amicotti â€” Quito & Valles</footer>

  <!-- === JS ÃšNICO === -->
  <script>
  /* ================ CONFIG ================ */
  const WA_PHONE = "593995315716";

  /* CSVs (con rutas alternativas por si cambian de carpeta) */
  const CSV_SOURCES = [
    { name: "purina",    paths: ["data/purina.csv","assets/data/purina.csv","assets/purina.csv","purina.csv"] },
    { name: "royal",     paths: ["data/royal.csv", "assets/data/royal.csv", "assets/royal.csv", "royal.csv"] },
    { name: "ferplast",  paths: ["data/ferplast.csv","assets/data/ferplast.csv","assets/ferplast.csv","ferplast.csv"] },
    { name: "catit",     paths: ["data/catit.csv","assets/data/catit.csv","assets/catit.csv","catit.csv"] }
  ];

  const IMG_EXTS = [".webp",".jpg",".jpeg",".png",".avif"];
  const FORM_ID="1FAIpQLSfsSxhFoBs9Xkv5MmYjTwr98zTSR6IefJ-vm2p9FSUOMSs69g";

  /* ================ ESTADO ================ */
  let PRODUCTS = [];
  let CART = loadCart();
  const SELECTED = Object.create(null);

  /* ============ HELPERS TELÃ‰FONO ============ */
  function normalizeEcPhone(raw){
    const digits = String(raw||'').replace(/\D+/g,'');
    if(digits.startsWith('593')) return '593'+digits.slice(3,12);
    if(digits.startsWith('09')) return '0'+digits.slice(1,10);
    if(digits.startsWith('9'))  return '0'+digits.slice(0,9);
    return digits.slice(0,10);
  }
  function isValidEcPhone(raw){
    const n = normalizeEcPhone(raw);
    return /^0?9\d{8}$/.test(n) || /^5939\d{8}$/.test(n);
  }
  function prettyEcPhone(raw){
    const n = normalizeEcPhone(raw);
    if(/^0?9\d{8}$/.test(n)){ const t = n.startsWith('0')?n:'0'+n; return `${t.slice(0,3)} ${t.slice(3,6)} ${t.slice(6,10)}`; }
    if(/^5939\d{8}$/.test(n)){ const t = '0'+n.slice(3); return `${t.slice(0,3)} ${t.slice(3,6)} ${t.slice(6,10)}`; }
    return raw;
  }

  /* Dinero: vacÃ­o => "Consultar" */
  const money = (n) => {
    if (n === null || n === undefined || n === '') return 'Consultar';
    const num = +n;
    return (Number.isFinite(num) && num >= 0) ? ('$' + num.toFixed(2)) : 'Consultar';
  };

  /* ===== Parsing de variantes/peso ===== */
  function gramsFromLabel(lbl){
    if(!lbl) return null; if(/unidad/i.test(lbl)) return null;
    let m = lbl.match(/([\d.,]+)\s*kg/i);
    if(m){ const v=parseFloat(m[1].replace(',','.')); return isNaN(v)?null:Math.round(v*1000); }
    m = lbl.match(/([\d.,]+)\s*g/i);
    if(m){ const v=parseFloat(m[1].replace(',','.')); return isNaN(v)?null:Math.round(v); }
    return null;
  }
  function parseVariants(str){
    if(!str) return [];
    return String(str).split('|').map(s=>{
      const raw = s.trim();
      const parts = raw.split(/[:\-â€”]+/);
      const label = (parts[0]||'').trim();
      const grams = gramsFromLabel(label);
      let price = null;
      if(parts[1]){
        const num = parseFloat(parts[1].replace('$','').trim());
        if(!isNaN(num)) price = num;
      }
      return label ? { label, grams, price } : null;
    }).filter(Boolean);
  }
  const unique = (arr,key)=>[...new Set(arr.map(o => (o[key]||'').trim()).filter(Boolean))].sort();
  const cap = s => (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase().replace(/^\w/, c=>c.toUpperCase());

  /* ================ WHATSAPP ================ */
  function setWALinks(){
    const url = `https://wa.me/${WA_PHONE}`;
    const top = document.getElementById('waTop');
    const flo = document.getElementById('waFloat');
    if(top){ top.href=url; top.textContent=`WhatsApp ${WA_PHONE}`; }
    if(flo){ flo.href=url; }
  }

  /* ================ CARRITO ================= */
  const body = document.body, overlay = document.getElementById('overlay');
  function loadCart(){ try{ return JSON.parse(localStorage.getItem('amicart'))||[] }catch{ return [] } }
  function saveCart(){ localStorage.setItem('amicart', JSON.stringify(CART)); updateCartBadge(); }
  function updateCartBadge(){ const c=CART.reduce((a,i)=>a+i.qty,0); document.getElementById('cartCount').textContent=c; }

  function openCart(){ document.getElementById('cartDrawer').classList.add('open'); overlay.classList.add('show'); body.classList.add('no-scroll'); }
  function closeCart(){ document.getElementById('cartDrawer').classList.remove('open'); overlay.classList.remove('show'); body.classList.remove('no-scroll'); }
  overlay.addEventListener('click', closeCart);

  function addToCartById(pid){
    const p = PRODUCTS.find(x=>x.id===pid);
    if(!p) return;
    const idx = Number.isInteger(SELECTED[pid]) ? SELECTED[pid] : 0;
    const v = (p.variants && p.variants[idx]) || null;
    const key = pid + '::' + (v?v.label:'');
    const item = { key, sku: pid, nombre: p.nombre, presentacion: v ? v.label : '', peso_g: v ? v.grams : (p.peso_g || null), precio: v ? v.price : (p.precio ?? null), qty: 1 };
    const i = CART.findIndex(x=>x.key===key);
    if(i>=0) CART[i].qty += 1; else CART.push(item);
    saveCart(); drawCart(); openCart();
  }
  function chgQty(key,d){ const i=CART.findIndex(x=>x.key===key); if(i<0) return; CART[i].qty += d; if(CART[i].qty<=0) CART.splice(i,1); saveCart(); drawCart(); }
  function removeFromCart(key){ CART = CART.filter(x=>x.key!==key); saveCart(); drawCart(); }
  function cartSubtotal(){ return CART.reduce((a,i)=> a + (i.precio!=null ? i.precio*i.qty : 0), 0); }

  function drawCart(){
    const list = document.getElementById('cartItems');
    const subEl = document.getElementById('cartSubtotal');
    const totEl = document.getElementById('cartTotal');
    if(!CART.length){ list.innerHTML = `<p class='text-sm text-gray-500'>Tu carrito estÃ¡ vacÃ­o.</p>`; subEl.textContent = '$0.00'; totEl.textContent = '$0.00'; return; }
    list.innerHTML = CART.map(it=>{
      const subtotal = it.precio!=null ? it.precio*it.qty : null;
      return `
      <div class='flex items-start justify-between gap-2'>
        <div class='text-sm'>
          <div class='font-medium'>${it.nombre}</div>
          <div class='text-gray-500'> ${it.sku||''} ${it.presentacion?('â€¢ '+it.presentacion):''} </div>
          <div>${money(it.precio)}</div>
          <div class='flex items-center gap-2 mt-1'>
            <button class='border px-2 rounded' onclick="chgQty('${it.key}',-1)">âˆ’</button>
            <span>${it.qty}</span>
            <button class='border px-2 rounded' onclick="chgQty('${it.key}',1)">+</button>
          </div>
        </div>
        <div class='text-right'>
          ${subtotal!=null?`<div class='font-semibold'>${money(subtotal)}</div>`:''}
          <button class='text-red-500 text-sm mt-2' onclick="removeFromCart('${it.key}')">Eliminar</button>
        </div>
      </div>`;
    }).join('');
    const sub = cartSubtotal(); subEl.textContent = money(sub); totEl.textContent = money(sub);
  }

  /* ================ IMG FALLBACK ================ */
  const swapExt = (url,ext)=>{ const i=url.lastIndexOf('.'); return i<0? url+ext : url.slice(0,i)+ext; };

  // Alias de marcas â†’ carpeta de imÃ¡genes
  const BRAND_ALIASES = {
    'royal canin':'royal','royal':'royal','purina':'purina','ferplast':'ferplast',
    // Grupo Catit y asociados:
    'catit':'catit','dogit':'catit','le salon':'catit','nerf dog':'catit','nerf':'catit',
    'nylabone':'catit','odor defense':'catit','petmate':'catit','sentry':'catit','zeus':'catit'
  };
  const slugify = s => (s||'').toString().trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function folderForBrand(brand){
    const b=(brand||'').toLowerCase();
    for(const key of Object.keys(BRAND_ALIASES)){ if(b.includes(key)) return BRAND_ALIASES[key]; }
    const slug = slugify(brand); return slug || 'catalog';
  }

  function buildImgCandidates(p){
    const brand = p.marca || '';

    // URL explÃ­cita del CSV
    if(p.imagen_url && p.imagen_url.trim()){
      const first=p.imagen_url.trim(); const alts=IMG_EXTS.map(e=>swapExt(first,e));
      return [first, ...alts].filter((v,i,a)=>a.indexOf(v)===i);
    }

    // Bases: alias (ej. Zeusâ†’catit), slug por si creas carpeta, y catÃ¡logo genÃ©rico
    const primary = `assets/${folderForBrand(brand)}/`;
    const bySlug  = `assets/${slugify(brand)}/`;
    const bases = [primary];
    if (bySlug !== primary) bases.push(bySlug);
    bases.push('assets/catalog/');

    const out=[];
    for(const base of bases){ for(const ext of IMG_EXTS){ out.push(`${base}${p.id}${ext}`); } }
    return [...new Set(out)];
  }

  function onImgError(el){
    const rest=(el.dataset.alt||"").split("|").filter(Boolean);
    if(rest.length){ el.src=rest.shift(); el.dataset.alt=rest.join("|"); return; }
    el.onerror=null; el.src="assets/logo.png";
  }
  function onImgLoad(el){ el.classList.add('loaded'); }

  /* ================ CSV / PRODUCTOS ================ */
  function mapSpeciesBrand(spec){
    const s = (spec||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
    if(s==='cat') return 'Gato';
    if(s==='dog') return 'Perro';
    if(s==='cat dog' || s==='dog cat' || (s.includes('cat') && s.includes('dog'))) return 'Ambos';
    if(!s) return 'Accesorios';
    return cap(s);
  }
  function mapCategoryBrand(cat){
    const c = (cat||'').toString().trim().toLowerCase();
    const dict = {
      dry:'Seco', wet:'HÃºmedo', veterinary:'Veterinario', treats:'Snack',
      treat:'Snack', snacks:'Snack', snack:'Snack',
      carrier:'Transportadoras', carriers:'Transportadoras',
      bowl:'Platos', bowls:'Platos', feeder:'Bebederos', feeders:'Bebederos',
      bed:'Camas', beds:'Camas', toy:'Juguetes', toys:'Juguetes',
      leash:'Correas', harness:'ArnÃ©s', harnesses:'ArnÃ©s',
      litter:'Arena', grooming:'Cuidado', cleaning:'Limpieza',
      cage:'Jaulas', cages:'Jaulas'
    };
    return dict[c] || (c ? cap(c) : '');
  }

  async function fetchCsvText(paths){
    for(const url of paths){
      try{
        const resp = await fetch(url, {cache:'no-store'});
        if(resp.ok){
          const text = await resp.text();
          if(!/^<!doctype\s+html/i.test(text.trim())) return { url, text };
        }
      }catch(e){}
    }
    return null;
  }

  async function loadCSVs(){
    const arrays = [];
    for(const src of CSV_SOURCES){
      const got = await fetchCsvText(src.paths);
      if(!got) continue;
      const parsed = Papa.parse(got.text, {header:true, skipEmptyLines:true});
      const rows = parsed.data || [];

      const normalized = rows.map((r, idx)=>{
        const hasBrandSchema = ('brand' in r) || ('name' in r) || ('species' in r);
        if(hasBrandSchema){
          const especie = mapSpeciesBrand(r.species);
          const categoria = mapCategoryBrand(r.category);
          const variants = parseVariants(r.variants||'');
          const first = variants[0] || null;
          return {
            id: (r.id||('row'+idx)).toString().trim(),
            marca: (r.brand||src.name||'').toString().trim().replace(/\s+/g,' ').replace(/^\w/,c=>c.toUpperCase()),
            linea:'', especie, categoria,
            nombre:(r.name||'').toString().trim(),
            peso_g:first?first.grams:null, sku:'', precio:first?first.price:null,
            imagen_url:(r.image_url||'').toString().trim(), descripcion:'', disponible:true, variants
          };
        }else{
          const variants=parseVariants(r.variants||''); const first=variants[0]||null;
          return {
            id:(r.id||('row'+idx)).toString().trim(),
            marca:(r.marca||src.name||'').toString().trim(),
            linea:(r.linea||'').toString().trim(),
            especie:(r.especie||'').toString().trim(),
            categoria:(r.categoria||'').toString().trim(),
            nombre:(r.nombre||'').toString().trim(),
            peso_g:r.peso_g?Number(r.peso_g):(first?first.grams:null),
            sku:(r.sku||'').toString().trim(),
            precio:(r.precio!=='' && r.precio!=null)?Number(r.precio):(first?first.price:null),
            imagen_url:(r.imagen_url||'').toString().trim(),
            descripcion:(r.descripcion||'').toString().trim(),
            disponible:String(r.disponible||'1')==='1',
            variants
          };
        }
      }).filter(p=>p.disponible);

      arrays.push(normalized);
    }
    PRODUCTS = arrays.flat();
  }

  /* ================ FILTROS + RENDER ================ */
  const grid = document.getElementById('grid');
  const alertBox = document.getElementById('alertBox');

  // header (desktop)
  const fMarca = document.getElementById('fMarca');
  const fEspecie = document.getElementById('fEspecie');
  const fCategoria = document.getElementById('fCategoria');
  const fSearch = document.getElementById('fSearch');
  const fSort = document.getElementById('fSort');

  // mÃ³vil
  const m_fMarca = document.getElementById('m_fMarca');
  const m_fEspecie = document.getElementById('m_fEspecie');
  const m_fCategoria = document.getElementById('m_fCategoria');
  const m_fSearch = document.getElementById('m_fSearch');
  const m_fSort = document.getElementById('m_fSort');

  const urlParams = new URLSearchParams(location.search);
  const norm = v => (v||'').toString().trim().toLowerCase();
  function mapEspecie(v){
    v=norm(v);
    if(v==='cat'||v==='gato') return 'Gato';
    if(v==='dog'||v==='perro') return 'Perro';
    if(v==='ambos'||v==='both') return 'Ambos';
    if(v==='accesorios'||v==='accesorio') return 'Accesorios';
    return '';
  }
  function mapCategoria(v){
    v=norm(v);
    if(v==='dry'||v==='seco') return 'Seco';
    if(v==='wet'||v==='hÃºmedo'||v==='humedo') return 'HÃºmedo';
    if(v==='veterinary'||v==='veterinario'||v==='vet') return 'Veterinario';
    if(v==='snack'||v==='treats'||v==='treat') return 'Snack';
    if(v==='carrier') return 'Transportadoras';
    return v ? cap(v) : '';
  }

  function updateURLFromFilters(){
    const params = new URLSearchParams();
    if(fMarca.value) params.set('marca', fMarca.value);
    if(fEspecie.value) params.set('especie', fEspecie.value);
    if(fCategoria.value) params.set('categoria', fCategoria.value);
    if(fSearch.value.trim()) params.set('q', fSearch.value.trim());
    if(fSort.value) params.set('orden', fSort.value);
    const qs=params.toString();
    history.replaceState(null,'',window.location.pathname+(qs?('?'+qs):'')); 
  }
  function fillSelect(sel, values){ sel.innerHTML = values.map((v,i)=>`<option value="${i===0?'':v}">${v}</option>`).join(''); }
  function mirrorMobileFromDesktop(){ m_fMarca.value=fMarca.value; m_fEspecie.value=fEspecie.value; m_fCategoria.value=fCategoria.value; m_fSearch.value=fSearch.value; m_fSort.value=fSort.value; }
  function mirrorDesktopFromMobile(){ fMarca.value=m_fMarca.value; fEspecie.value=m_fEspecie.value; fCategoria.value=m_fCategoria.value; fSearch.value=m_fSearch.value; fSort.value=m_fSort.value; }

  function fillFilters(){
    const marcas=['Marcaâ€¦', ...unique(PRODUCTS,'marca')];
    const especiesSet = [...new Set(PRODUCTS.map(p=>p.especie).filter(Boolean))].sort();
    const especies = ['Especieâ€¦', ...especiesSet];
    const cats=['CategorÃ­aâ€¦', ...unique(PRODUCTS,'categoria')];

    fillSelect(fMarca,marcas); fillSelect(fEspecie,especies); fillSelect(fCategoria,cats);
    fillSelect(m_fMarca,marcas); fillSelect(m_fEspecie,especies); fillSelect(m_fCategoria,cats);
  }

  function applyInitialFiltersFromURL(){
    const marcaParam=urlParams.get('marca'); if(marcaParam){ fMarca.value=marcaParam; }
    const espParam=urlParams.get('especie'); if(espParam){ fEspecie.value=mapEspecie(espParam); }
    const catParam=urlParams.get('categoria'); if(catParam){ fCategoria.value=mapCategoria(catParam); }
    const qParam=urlParams.get('q'); if(qParam){ fSearch.value=qParam; }
    const sortParam=urlParams.get('orden'); if(sortParam){ fSort.value=sortParam; }
    mirrorMobileFromDesktop();
  }

  function getFiltered(){
    const m=fMarca.value, e=fEspecie.value, c=fCategoria.value, q=(fSearch.value||'').trim().toLowerCase();
    let out = PRODUCTS.filter(p=>
      (!m || p.marca===m) && (!e || p.especie===e) && (!c || p.categoria===c) &&
      (!q || p.nombre.toLowerCase().includes(q) || p.linea.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q))
    );
    switch(fSort.value){
      case 'precio-asc': out.sort((a,b)=>((a.variants?.[0]?.price ?? a.precio ?? 1e9) - (b.variants?.[0]?.price ?? b.precio ?? 1e9))); break;
      case 'precio-desc': out.sort((a,b)=>((b.variants?.[0]?.price ?? b.precio ?? -1) - (a.variants?.[0]?.price ?? a.precio ?? -1))); break;
      case 'nombre-asc': out.sort((a,b)=>a.nombre.localeCompare(b.nombre)); break;
      case 'nombre-desc': out.sort((a,b)=>b.nombre.localeCompare(a.nombre)); break;
    }
    return out;
  }

  function onChangeVariant(pid, idx){
    SELECTED[pid]=Number(idx)||0;
    const p=PRODUCTS.find(x=>x.id===pid); if(!p) return;
    const v=p.variants[SELECTED[pid]]||null;
    const priceEl=document.getElementById('price-'+pid);
    if(priceEl) priceEl.textContent = v ? money(v.price) : money(p.precio);
  }

  function cardHTML(p){
    const candidates=buildImgCandidates(p);
    const img=candidates[0], altList=candidates.slice(1).join("|");
    const isVet = (p.categoria.toLowerCase()==='veterinario');
    const badgeVet = isVet ? `<span class='px-2 py-0.5 text-[10px] bg-rose-100 text-rose-700 rounded'>Veterinario</span>` : '';
    const variantsSel = (p.variants && p.variants.length)
      ? `<label class="block text-xs text-gray-500 mt-2">PresentaciÃ³n</label>
         <select class="w-full border p-2 rounded text-sm" onchange="onChangeVariant('${p.id}', this.value)">
           ${p.variants.map((v,i)=>`<option value="${i}">${v.label}${v.price!=null?(' â€” '+money(v.price)):''}</option>`).join('')}
         </select>`
      : `<p class='text-xs text-gray-500 mt-1'>PresentaciÃ³n: ${p.peso_g? (p.peso_g>=1000? (p.peso_g/1000)+' kg' : p.peso_g+' g') : 'â€”'}</p>`;
    const initialPrice=(p.variants && p.variants.length)? money(p.variants[0].price) : money(p.precio);
    return `<article class='border rounded-lg overflow-hidden bg-white'>
      <div class='img-box w-full bg-gray-50 grid place-items-center'>
      <img src='${img}'
     data-alt='${altList}'
     alt='${p.nombre}'
     loading='lazy' decoding='async'
     onload="onImgLoad(this)"
     onclick="openZoomFromImg(this)"
     onerror="onImgError(this)"/>
      </div>
      <div class='p-3 space-y-1'>
        <h3 class='font-medium leading-tight'>${p.nombre}</h3>
        <p class='text-xs text-gray-500'>${p.marca} â€¢ ${p.linea || 'â€”'} â€¢ ${p.especie}${badgeVet?(' '+badgeVet):''}</p>
        <p class='text-[11px] text-gray-400'>${p.categoria||'â€”'}</p>
        ${variantsSel}
        <div class='flex items-center justify-between pt-2'>
          <strong id="price-${p.id}">${initialPrice}</strong>
          <button class='px-2 py-1 border rounded text-sm' onclick="addToCartById('${p.id}')">Agregar</button>
        </div>
      </div>
    </article>`;
  }

  function render(){
    const items=getFiltered();
    if(!items.length){ grid.innerHTML = `<div class='col-span-full p-6 text-center text-sm text-gray-500 border rounded'>No hay productos con esos filtros.</div>`; return; }
    items.forEach(p=>{ if(!(p.id in SELECTED)) SELECTED[p.id]=0; });
    grid.innerHTML = items.map(cardHTML).join('');

    // Si el navegador sirviÃ³ desde cachÃ© y no disparÃ³ onload:
    document.querySelectorAll('#grid .img-box img').forEach(img=>{
      if (img.complete && img.naturalWidth > 0) img.classList.add('loaded');
    });
  }

  /* ======== CHECKOUT ======== */
  function goToCheckout(){
    if(!CART.length){ alert('Tu carrito estÃ¡ vacÃ­o.'); return; }
    localStorage.setItem('amicotti_checkout_source','catalog');
    location.href = 'checkout.html';
  }

  /* ============== EVENTOS ============== */
  [fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el =>
    el.addEventListener('input', ()=>{ render(); updateURLFromFilters(); mirrorMobileFromDesktop(); })
  );
  document.getElementById('clearFilters').addEventListener('click',()=>{
    [fMarca,fEspecie,fCategoria,fSearch,fSort].forEach(el=> el.value=''); render(); updateURLFromFilters(); mirrorMobileFromDesktop();
  });

  // mÃ³vil
  const panel=document.getElementById('filtersPanel');
  document.getElementById('openFilters').addEventListener('click', ()=> panel.classList.toggle('hidden'));
  [m_fMarca,m_fEspecie,m_fCategoria,m_fSearch,m_fSort].forEach(el =>
    el.addEventListener('input', ()=>{ mirrorDesktopFromMobile(); render(); updateURLFromFilters(); })
  );
  document.getElementById('m_clearFilters').addEventListener('click',()=>{
    [m_fMarca,m_fEspecie,m_fCategoria,m_fSearch,m_fSort].forEach(el=> el.value=''); mirrorDesktopFromMobile(); render(); updateURLFromFilters();
  });

  // drawer / carrito
  document.getElementById('cartBtn').addEventListener('click', openCart);
  document.getElementById('closeCart').addEventListener('click', closeCart);
  document.getElementById('btnEmpty').addEventListener('click', ()=>{ if(confirm('Â¿Vaciar carrito?')){ CART=[]; saveCart(); drawCart(); } });
  document.getElementById('btnCheckout').addEventListener('click', goToCheckout);
  document.getElementById('buyerForm')?.addEventListener('submit', e => e.preventDefault());
    
<!-- Modal de Zoom -->
<div id="zoomModal" class="zoom-modal" aria-hidden="true">
  <div class="zoom-frame">
    <div class="zoom-toolbar">
      <button id="zoomClose" title="Cerrar (Esc)">âœ•</button>
      <button id="zoomReset" title="Restablecer">100%</button>
      <button id="zoomOut" title="Alejar">âˆ’</button>
      <button id="zoomIn" title="Acercar">ï¼‹</button>
    </div>
    <div id="zoomStage" class="zoom-stage">
      <img id="zoomImg" alt="Vista ampliada" onerror="onZoomImgError(this)"/>
    </div>
    <div id="zoomCaption" class="zoom-caption">Arrastra para mover â€¢ Rueda o pellizca para acercar</div>
  </div>
</div>

  /* ============== INIT ============== */
  (async function init(){
    setWALinks(); updateCartBadge(); drawCart();
    try{
      await loadCSVs();
      if(!PRODUCTS.length){
        alertBox.classList.remove('hidden');
        alertBox.textContent='No se cargaron productos. Revisa las rutas CSV.';
      }
      PRODUCTS = PRODUCTS.map(p => ({...p, marca: cap(p.marca)}));
      fillFilters(); applyInitialFiltersFromURL(); render();
      // Prefill buyer (aunque estÃ© oculto)
      try{
        const b=JSON.parse(localStorage.getItem('amicotti_buyer')||'{}');
        if(b.name) document.getElementById('bf_name').value=b.name;
        if(b.address) document.getElementById('bf_address').value=b.address;
        if(b.phone) document.getElementById('bf_phone').value=b.phone;
      }catch(e){}
    }catch(e){
      console.error(e);
      alertBox.classList.remove('hidden');
      alertBox.textContent='Error cargando el catÃ¡logo. Verifica rutas y formato del CSV.';
    }
  })();
  </script>
</body>
</html>
