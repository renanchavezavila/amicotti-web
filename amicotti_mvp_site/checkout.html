<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Amicotti ‚Äî Finalizar pedido</title>
  <link rel="icon" href="/assets/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>:root{--pastel:#F6F3E9}</style>
</head>
<body class="bg-white text-gray-900">
  <header class="border-b bg-[color:var(--pastel)]">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/catalogo.html" class="flex items-center gap-2"><img src="/assets/logo.png" class="w-8 h-8" alt="Logo Amicotti"><strong>Amicotti</strong></a>
      <a href="/cart.html" class="px-3 py-2 border rounded">Ver carrito</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid lg:grid-cols-2 gap-6">
    <!-- Formulario -->
    <section class="space-y-4">
      <h1 class="text-xl font-semibold">Contacto & Entrega</h1>
      <form id="form" class="space-y-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Correo electr√≥nico (opcional)</label>
          <input id="email" type="email" class="w-full border rounded px-3 py-2" autocomplete="email">
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Nombre</label>
            <input id="name" class="w-full border rounded px-3 py-2" required autocomplete="name">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Tel√©fono (WhatsApp)</label>
            <input id="phone" class="w-full border rounded px-3 py-2" required inputmode="tel" autocomplete="tel">
            <p id="phone_help" class="hidden text-[11px] text-rose-600 mt-1">N√∫mero m√≥vil de Ecuador.</p>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Direcci√≥n exacta</label>
          <input id="address" class="w-full border rounded px-3 py-2" required autocomplete="street-address">
          <p class="text-[11px] text-gray-500 mt-1">Podr√°s compartir tu ubicaci√≥n (pin) en el chat.</p>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-2">Forma de pago</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
              <input type="radio" name="pay" value="Transferencia Bancaria" checked>
              <span class="text-sm">Transferencia bancaria</span>
            </label>
            <label class="flex items-center gap-2 border rounded px-3 py-2 cursor-pointer">
              <input type="radio" name="pay" value="Contraentrega (efectivo)">
              <span class="text-sm">Contraentrega (efectivo)</span>
            </label>
          </div>
        </div>
        <label class="flex items-start gap-2 text-sm select-none">
          <input id="consent" type="checkbox" required class="mt-1">
          <span>Acepto que Amicotti use mis datos para coordinar la entrega y enviar novedades.</span>
        </label>
      </form>
      <div class="flex gap-2">
        <a href="/catalogo.html" class="px-3 py-2 border rounded">Volver al cat√°logo</a>
        <!-- Importante: <a> en vez de <button> para que la navegaci√≥n a WhatsApp sea inmediata -->
        <a id="waSend"
           role="button"
           class="px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700"
           href="#"
           target="_self">Enviar por WhatsApp</a>
      </div>
    </section>

    <!-- Resumen -->
    <aside class="space-y-4">
      <h2 class="text-xl font-semibold">Resumen</h2>
      <div id="summary" class="space-y-3"></div>
      <div class="p-4 border rounded bg-gray-50 space-y-1">
        <div class="flex justify-between text-sm text-gray-600"><span>Subtotal</span><strong id="sub">$0.00</strong></div>
        <div class="flex justify-between text-sm text-gray-600"><span>Env√≠o</span><span>Gratis/por confirmar</span></div>
        <div class="flex justify-between"><span class="font-semibold">Total estimado</span><strong id="tot">$0.00</strong></div>
      </div>
    </aside>
  </main>

  <script>
    // Config
    const WA_PHONE = "593995315716"; // E.164 sin '+'
    const FORM_ID = "1FAIpQLSfsSxhFoBs9Xkv5MmYjTwr98zTSR6IefJ-vm2p9FSUOMSs69g";
    const ENTRY_PAYMETHOD="entry.1704422038",ENTRY_NAME="entry.1205890323",ENTRY_ADDRESS="entry.1074248946",ENTRY_PHONE="entry.646283436",ENTRY_CART="entry.1875788310",ENTRY_TOTAL="entry.624785838",ENTRY_SOURCE="entry.1894560572";

    // Utils
    function money(n){const x=Number(n);return (Number.isFinite(x)&&x>=0)?('$'+x.toFixed(2)):'Consultar';}
    function normalizeEcPhone(raw){const d=String(raw||'').replace(/\D+/g,'');if(d.startsWith('593'))return'593'+d.slice(3,12);if(d.startsWith('09'))return'0'+d.slice(1,10);if(d.startsWith('9'))return'0'+d.slice(0,9);return d.slice(0,10);}
    function isValidEcPhone(raw){const n=normalizeEcPhone(raw);return /^0?9\d{8}$/.test(n)||/^5939\d{8}$/.test(n);}
    function prettyEcPhone(raw){const n=normalizeEcPhone(raw);if(/^0?9\d{8}$/.test(n)){const ten=n.startsWith('0')?n:'0'+n;return `${ten.slice(0,3)} ${ten.slice(3,6)} ${ten.slice(6,10)}`;} if(/^5939\d{8}$/.test(n)){const ten='0'+n.slice(3);return `${ten.slice(0,3)} ${ten.slice(3,6)} ${ten.slice(6,10)}`;} return raw;}
    function subtotal(){const C=JSON.parse(localStorage.getItem('amicart')||'[]');return C.reduce((a,i)=>a+(i.precio!=null?i.precio*i.qty:0),0);}
    function drawSummary(){
      const wrap=document.getElementById('summary');
      const C=JSON.parse(localStorage.getItem('amicart')||'[]');
      if(!C.length){wrap.innerHTML=`<p class="text-sm text-gray-500">Tu carrito est√° vac√≠o.</p>`;return;}
      wrap.innerHTML=C.map(it=>`
        <div class="flex items-start justify-between gap-3 p-3 border rounded">
          <div>
            <div class="font-medium">${it.nombre}</div>
            <div class="text-gray-500 text-sm">${it.presentacion||''}</div>
            <div class="text-sm mt-1">${money(it.precio)} √ó ${it.qty}</div>
          </div>
          <div class="font-semibold">${it.precio!=null? money(it.precio*it.qty):''}</div>
        </div>
      `).join('');
      document.getElementById('sub').textContent = money(subtotal());
      document.getElementById('tot').textContent = money(subtotal());
    }
    function prefill(){
      try{
        const b=JSON.parse(localStorage.getItem('amicotti_buyer')||'{}');
        if(b.name) document.getElementById('name').value=b.name;
        if(b.address) document.getElementById('address').value=b.address;
        if(b.phone) document.getElementById('phone').value=b.phone;
      }catch(e){}
    }
    function buildWAMessage(buyer){
      const C=JSON.parse(localStorage.getItem('amicart')||'[]');
      const lines=[];
      lines.push('Pedido Amicotti');
      lines.push(`Nombre: ${buyer.name}`); lines.push(`Direcci√≥n: ${buyer.address}`); lines.push(`Tel√©fono: ${buyer.phone}`); lines.push(`Forma de pago: ${buyer.pay||'‚Äî'}`); lines.push('');
      lines.push('Items:');
      C.forEach(it=>{
        const qty=Number(it.qty||1), p=Number(it.precio||0), total=(p*qty).toFixed(2);
        const pres= it.presentacion? ` ‚Äî ${it.presentacion}` : '';
        lines.push(`‚Ä¢ ${it.nombre}${pres} ‚Äî $${p.toFixed(2)} √ó ${qty} = $${total}`);
      });
      const sub=subtotal().toFixed(2);
      lines.push(''); lines.push(`Subtotal: $${sub}`); lines.push('Env√≠o: por confirmar (Quito/Valles)'); lines.push(`Total Estimado : $${sub}`); lines.push(''); lines.push('Por favor comparte tu ubicaci√≥n (pin) en este chat. ¬°Gracias! üêæ');
      return lines.join('\n');
    }

    // Env√≠o a Google Forms en segundo plano (iOS-friendly)
    function sendToGoogleFormsBeacon(buyer){
      if(!FORM_ID) return;
      const endpoint=`https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
      const params=new URLSearchParams();
      const sub = subtotal().toFixed(2);
      if(ENTRY_NAME) params.append(ENTRY_NAME, buyer.name);
      if(ENTRY_ADDRESS) params.append(ENTRY_ADDRESS, buyer.address);
      if(ENTRY_PHONE) params.append(ENTRY_PHONE, buyer.phone);
      if(ENTRY_PAYMETHOD) params.append(ENTRY_PAYMETHOD, buyer.pay);
      if(ENTRY_TOTAL) params.append(ENTRY_TOTAL, sub);
      if(ENTRY_CART) params.append(ENTRY_CART, localStorage.getItem('amicart')||'[]');
      if(ENTRY_SOURCE) params.append(ENTRY_SOURCE, 'site-amicotti');

      try{
        if (navigator.sendBeacon) {
          const blob = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });
          navigator.sendBeacon(endpoint, blob);
        } else {
          // Respaldo: fetch "fire-and-forget"
          fetch(endpoint,{method:'POST',body:params,keepalive:true,mode:'no-cors'}).catch(()=>{});
        }
      } catch(_) {}
    }

    // Eventos de ayuda de tel√©fono
    const phoneInput=document.getElementById('phone'); const phoneHelp=document.getElementById('phone_help');
    phoneInput.addEventListener('input',()=>{
      const pos=phoneInput.selectionStart; const pretty=prettyEcPhone(phoneInput.value);
      phoneInput.value=pretty;
      if(isValidEcPhone(phoneInput.value)){ phoneInput.classList.remove('border-rose-400'); phoneHelp.classList.add('hidden'); }
      else{ phoneInput.classList.add('border-rose-400'); phoneHelp.classList.remove('hidden'); }
      try{ phoneInput.setSelectionRange(pos,pos); }catch(e){}
    });

    // Handler principal (sin await, sin window.open)
    document.getElementById('waSend').addEventListener('click', function () {
      const name=document.getElementById('name').value.trim();
      const address=document.getElementById('address').value.trim();
      const phone=document.getElementById('phone').value.trim();
      const pay=(document.querySelector('input[name="pay"]:checked')?.value||'').trim();
      const consent=document.getElementById('consent').checked;

      if(!JSON.parse(localStorage.getItem('amicart')||'[]').length){ alert('Tu carrito est√° vac√≠o.'); return; }
      if(!name||!address||!phone){ alert('Completa nombre, direcci√≥n y tel√©fono.'); return; }
      if(!isValidEcPhone(phone)){ alert('Revisa el tel√©fono (09xxxxxxxx o +5939xxxxxxxx).'); return; }
      if(!consent){ alert('Debes aceptar el uso de datos.'); return; }

      const buyer={name, address, phone:prettyEcPhone(phone), pay};
      localStorage.setItem('amicotti_buyer', JSON.stringify(buyer));

      // 1) Dispara guardado en segundo plano (no bloquea la navegaci√≥n)
      sendToGoogleFormsBeacon(buyer);

      // 2) Prepara mensaje y limpia carrito ANTES de salir
      const text = encodeURIComponent(buildWAMessage(buyer));
      const waUrl = `https://api.whatsapp.com/send?phone=${WA_PHONE}&text=${text}`;
      localStorage.setItem('amicart','[]');

      // 3) Navega a WhatsApp en la MISMA pesta√±a (gesto de usuario ‚Äì iOS ok)
      this.href = waUrl;
      this.target = '_self';
      // No preventDefault, no window.open
    }, { passive: true });

    // init
    drawSummary(); prefill();
  </script>
</body>
</html>
